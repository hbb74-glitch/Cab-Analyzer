--- /mnt/data/cab17_orig/Cab-Analyzer-main/client/src/pages/Analyzer.tsx	2026-02-18 04:47:43.000000000 +0000
+++ /mnt/data/cab17/Cab-Analyzer-main/client/src/pages/Analyzer.tsx	2026-02-18 05:00:19.253984901 +0000
@@ -1228,52 +1228,11 @@
     return hints.length > 0 ? hints.join(', ') : 'neutral';
   };
 
-  const getPreferenceRole = (idx: number): string | undefined => {
-    if (!preferenceMap) return undefined;
-    const pref = preferenceMap.get(irs[idx].filename);
-    if (!pref || pref.bestScore < 35) return undefined;
-    return pref.bestProfile === "Featured" ? "Feature element" : "Body element";
-  };
-
-  const roleDistribution = (() => {
-    if (!preferenceMap || preferenceMap.size === 0) return null;
-    let featureCount = 0;
-    let bodyCount = 0;
-    let unclassified = 0;
-    for (let i = 0; i < irs.length; i++) {
-      const pref = preferenceMap.get(irs[i].filename);
-      if (!pref || pref.bestScore < 35) { unclassified++; continue; }
-      if (pref.bestProfile === "Featured") featureCount++;
-      else bodyCount++;
-    }
-    const totalClassified = featureCount + bodyCount;
-    if (totalClassified < 5) return null;
-    const featureRatio = featureCount / totalClassified;
-    const bodyRatio = bodyCount / totalClassified;
-    const featureScarce = featureRatio < 0.25;
-    const bodyScarce = bodyRatio < 0.25;
-    return { featureCount, bodyCount, totalClassified, unclassified, featureRatio, bodyRatio, featureScarce, bodyScarce };
-  })();
+  // NOTE: The old preference-role system ("Featured"/"Body" element) is deprecated.
+  // Keep this hook returning undefined so no UI renders legacy labels.
+  const getPreferenceRole = (_idx: number): string | undefined => undefined;
+  const roleDistribution = null;
 
-  const getRoleScarcityBoost = (idx: number): number => {
-    if (roleBalanceMode === 'off' || !preferenceMap || !roleDistribution) return 0;
-    const pref = preferenceMap.get(irs[idx].filename);
-    if (!pref || pref.bestScore < 50) return 0;
-
-    const isScarceRole = (pref.bestProfile === "Featured" && roleDistribution.featureScarce) ||
-                         (pref.bestProfile === "Body" && roleDistribution.bodyScarce);
-    if (!isScarceRole) return 0;
-
-    const ratio = pref.bestProfile === "Featured" ? roleDistribution.featureRatio : roleDistribution.bodyRatio;
-    const scarcityFactor = Math.max(0, 1 - ratio * 4);
-    const confidenceScale = Math.min(1, (pref.bestScore - 50) / 50);
-    const qualityFloor = Math.max(0, ((irs[idx].score || 85) - 70) / 30);
-
-    if (roleBalanceMode === 'favor') {
-      return scarcityFactor * 10 * confidenceScale * qualityFloor + 3;
-    }
-    return scarcityFactor * 6 * confidenceScale * qualityFloor + 2;
-  };
+  const getRoleScarcityBoost = (_idx: number): number => 0;
@@ -1637,12 +1596,7 @@
   keep.sort((a, b) => b.diversityContribution - a.diversityContribution);
   cut.sort((a, b) => b.similarity - a.similarity);
 
-  const roleStats = roleDistribution ? {
-    featureCount: roleDistribution.featureCount,
-    bodyCount: roleDistribution.bodyCount,
-    totalClassified: roleDistribution.totalClassified,
-    featureKept: keep.filter(k => k.preferenceRole === "Feature element").length,
-    bodyKept: keep.filter(k => k.preferenceRole === "Body element").length
-  } : undefined;
+  const roleStats = undefined;
 
   return { 
     result: { keep, cut, closeCallsResolved: closeCalls.length === 0 },
     closeCalls,
@@ -2156,208 +2110,55 @@
-  interface PairingSuggestion {
-    filename: string;
-    index: number;
-    reason: string;
-  }
-
-  interface BatchIRRole {
-    role: "Feature element" | "Body element" | null;
-    featuredScore: number;
-    bodyScore: number;
-    bestScore: number;
-    unlikelyToUse: boolean;
-    unlikelyReason: string | null;
-    avoidHits: string[];
-    avoidTypes: string[];
-    pairingSuggestions: PairingSuggestion[];
-    pairingGuidance: string | null;
-  }
-
-  const batchPreferenceRoles = useMemo(() => {
-    if (!batchResult || !learnedProfile || learnedProfile.status === "no_data") return null;
-    ...
-    return roles;
-  }, [batchResult, learnedProfile, activeProfiles]);
+  // NOTE: Legacy preference-role blending guidance (feature/body element) has been deprecated.
+  // We keep this null so no UI renders outdated labels or guidance.
+  const batchPreferenceRoles = null as any;
 
+  // Compute musical role deterministically (single source of truth).
+  // Do NOT rely on mutating batchResult.results to add musicalRole, since that can fail to trigger re-renders.
+  const getMusicalRoleForRow = useCallback((r: any): string => {
+    const filename = safe(r?.filename ?? r?.name ?? "");
+    if (!filename) return "";
+
+    const stored = safe(r?.musicalRole ?? r?.musical_role ?? r?.role ?? "").trim();
+    if (stored) return stored;
+
+    const metricsForFile = batchMetricsByFilenameRef.current.get(filename);
+    const bandsFromBatch = {
+      subBass: ((Number(r.subBassPercent) || 0) / 100),
+      bass: ((Number(r.bassPercent) || 0) / 100),
+      lowMid: ((Number(r.lowMidPercent) || 0) / 100),
+      mid: ((Number(r.midPercent) || 0) / 100),
+      highMid: ((Number(r.highMidPercent) || 0) / 100),
+      presence: ((Number(r.presencePercent) || 0) / 100),
+      air: ((Number((r.airPercent ?? r.ultraHighPercent)) || 0) / 100),
+    };
+
+    const featureSource: any = {
+      ...r,
+      spectralCentroidHz:
+        ((metricsForFile as any)?.spectralCentroidHz ??
+        (metricsForFile as any)?.spectralCentroid ??
+        r?.spectralCentroidHz ??
+        r?.spectralCentroid ??
+        0),
+      bandsPercent: bandsFromBatch,
+    };
+
+    try {
+      const tf = computeTonalFeatures(featureSource);
+      const spk = inferSpeakerIdFromFilename(filename);
+      const st = speakerStatsRef.current.get(spk);
+      const base = classifyMusicalRole(tf, st);
+      return applyContextBias(base, tf, filename, st);
+    } catch {
+      return "";
+    }
+  }, []);
+
   const collectionCoverage = useMemo(() => {
     if (!batchResult?.results?.length) return null;
 
     const roles = batchResult.results
-      .map((r: any) => r.musicalRole)
+      .map((r: any) => getMusicalRoleForRow(r))
       .filter(Boolean);
@@ -2182,51 +2209,41 @@
     const leadPolish = count("Lead Polish");
     const fizzTamer = count("Fizz Tamer");
     const darkSpecialty = count("Dark Specialty");
 
-    const featureLayers = cutLayer + leadPolish;
-    const bodyLayers = foundation + midThickener;
-
-    const minForCategory = Math.max(2, Math.ceil(total * 0.15));
-    const hasBody = bodyLayers >= minForCategory;
-    const hasFeature = featureLayers >= minForCategory;
+    const minForCore = Math.max(2, Math.ceil(total * 0.15));
+    const hasFoundation = foundation >= minForCore;
+    const hasCut = cutLayer >= minForCore;
     const hasPolish = leadPolish >= 1;
+    const hasThick = midThickener >= Math.max(1, Math.ceil(total * 0.10));
 
     let verdict = "Limited coverage";
     let verdictColor = "text-red-400";
     const suggestions: string[] = [];
 
-    if (hasBody && hasFeature && hasPolish) {
+    if (hasFoundation && hasCut && hasPolish) {
       verdict = "Good coverage";
       verdictColor = "text-emerald-400";
-      suggestions.push(`Strong spread: ${bodyLayers} body layers (Foundation + Mid Thickener) and ${featureLayers} feature layers (Cut Layer + Lead Polish).`);
+      if (!hasThick) suggestions.push("Consider adding 1–2 Mid Thickeners for weight/body support (cone / CapEdge_Dk / CapEdge_Cone_Tr, ribbons, or farther distances).");
       if (fizzTamer < 1) suggestions.push("Add 1 dedicated Fizz Tamer (low air, low fizz) as a safety tool for harsher amp pairings.");
-    } else if (!hasBody && !hasFeature) {
-      verdict = "Limited coverage";
-      verdictColor = "text-red-400";
-      suggestions.push("Limited role variety in this batch. Add more contrasting shots to cover both body and feature layers.");
-      suggestions.push("For more Cut Layers: cap / CapEdge_Br with dynamic mics (SM57, MD421, MD441, PR30) at closer distances.");
-      suggestions.push("For more Body Layers: Cone or CapEdge_Dk / CapEdge_Cone_Tr with ribbon/darker dynamics (R121, M201) and/or slightly farther distances.");
-      suggestions.push("For Lead Polish: smooth captures with higher air_pct (6–9k) but controlled fizz — often CapEdge_Br or Cap/OffCenter at moderate distance.");
-    } else if (!hasFeature) {
-      verdict = "Needs more feature layers";
-      verdictColor = "text-amber-400";
-      suggestions.push(`Only ${featureLayers} feature layers (Cut + Polish). Add more cap / CapEdge_Br cut shots and at least 1 extra polish layer.`);
-    } else if (!hasBody) {
-      verdict = "Needs more body layers";
-      verdictColor = "text-amber-400";
-      suggestions.push(`Only ${bodyLayers} body layers (Foundation + Thickener). Add more Cone / CapEdge_Dk / CapEdge_Cone_Tr and/or ribbon body shots.`);
-    } else if (!hasPolish) {
-      verdict = "Needs at least one polish layer";
-      verdictColor = "text-amber-400";
-      suggestions.push("Add at least 1 Lead Polish (higher air_pct with high smooth score) to finish mixes without harshness.");
+    } else {
+      if (!hasCut) suggestions.push("Add more Cut Layers (cap / CapEdge_Br with dynamic mics like SM57/MD421/MD441/PR30 at closer distances).");
+      if (!hasFoundation) suggestions.push("Add more Foundations (balanced cap-edge / transition shots, moderate distances).");
+      if (!hasPolish) suggestions.push("Add at least 1 Lead Polish (smooth ≥ ~88 with higher air_pct 6–9k and controlled fizz).");
+      if (!hasThick) suggestions.push("Add at least 1 Mid Thickener (cone / darker transition positions, ribbons, slightly farther distances).");
     }
 
     return {
@@ -2234,9 +2251,7 @@
       verdictColor,
       suggestions,
       total,
-      featureLayers,
-      bodyLayers,
       foundation,
       cutLayer,
       midThickener,
@@ -2251,7 +2266,7 @@
       fizzTamer,
       darkSpecialty,
     };
-  }, [batchResult]);
+  }, [batchResult, getMusicalRoleForRow]);
@@ -4966,20 +4981,25 @@
                       </div>
                       <div className="flex flex-wrap gap-3 text-xs">
-                        <span className="px-2 py-1 rounded bg-cyan-500/10 text-cyan-400 font-mono" data-testid="text-feature-count">
-                          {collectionCoverage.featureLayers} feature layers
-                          <span className="text-muted-foreground"> (Cut {collectionCoverage.cutLayer}, Polish {collectionCoverage.leadPolish})</span>
-                        </span>
-                        <span className="px-2 py-1 rounded bg-amber-500/10 text-amber-400 font-mono" data-testid="text-body-count">
-                          {collectionCoverage.bodyLayers} body layers
-                          <span className="text-muted-foreground"> (Foundation {collectionCoverage.foundation}, Thick {collectionCoverage.midThickener})</span>
-                        </span>
-                        <span className="px-2 py-1 rounded bg-white/5 text-muted-foreground font-mono">
-                          Fizz Tamers {collectionCoverage.fizzTamer} • Dark {collectionCoverage.darkSpecialty}
-                        </span>
+                        <span className="px-2 py-1 rounded bg-cyan-500/10 text-cyan-400 font-mono">
+                          Cut Layers {collectionCoverage.cutLayer}
+                        </span>
+                        <span className="px-2 py-1 rounded bg-indigo-500/10 text-indigo-300 font-mono">
+                          Lead Polish {collectionCoverage.leadPolish}
+                        </span>
+                        <span className="px-2 py-1 rounded bg-emerald-500/10 text-emerald-300 font-mono">
+                          Foundations {collectionCoverage.foundation}
+                        </span>
+                        <span className="px-2 py-1 rounded bg-amber-500/10 text-amber-300 font-mono">
+                          Mid Thickeners {collectionCoverage.midThickener}
+                        </span>
+                        <span className="px-2 py-1 rounded bg-white/5 text-muted-foreground font-mono">
+                          Fizz Tamers {collectionCoverage.fizzTamer} • Dark Specialty {collectionCoverage.darkSpecialty}
+                        </span>
                       </div>
@@ -5340,7 +5360,7 @@
 
                                 {(() => {
-                                  const role = (r as any).musicalRole;
+                                  const role = getMusicalRoleForRow(r);
                                   if (!role) return null;
                                   return (
                                     <span
@@ -5356,7 +5376,7 @@
 
                             {!r.parsedInfo && (() => {
-                              const role = (r as any).musicalRole;
+                              const role = getMusicalRoleForRow(r);
                               if (!role) return null;
                               return (
                                 <div className="flex flex-wrap gap-1 mt-1">
@@ -5371,43 +5391,6 @@
                           )}>
                             {r.score}
                           </div>
                         </div>
-
-                        {batchPreferenceRoles?.[index]?.unlikelyToUse && (
-                          <div className="flex items-start gap-2 p-2 rounded bg-red-500/10 border border-red-500/20" data-testid={`warning-unlikely-${index}`}>
-                            <ShieldAlert className="w-3.5 h-3.5 text-red-400 mt-0.5 flex-shrink-0" />
-                            <div>
-                              <p className="text-xs font-medium text-red-400">Unlikely to use</p>
-                              <p className="text-[11px] text-red-400/70">{batchPreferenceRoles[index].unlikelyReason}</p>
-                            </div>
-                          </div>
-                        )}
-                        {batchPreferenceRoles && batchPreferenceRoles[index]?.avoidHits?.length > 0 && !batchPreferenceRoles[index]?.unlikelyToUse && (
-                          <div className="p-2.5 rounded bg-amber-500/10 border border-amber-500/20 space-y-2" data-testid={`warning-avoid-${index}`}>
-                            <div className="flex items-start gap-2">
-                              <AlertTriangle className="w-3.5 h-3.5 text-amber-400 mt-0.5 flex-shrink-0" />
-                              <div>
-                                <p className="text-[10px] text-amber-400/50 mb-0.5">Blend context — pair with a complement</p>
-                                <p className="text-[11px] text-amber-400/70">{batchPreferenceRoles[index].avoidHits.join(" | ")}</p>
-                              </div>
-                            </div>
-                            {batchPreferenceRoles[index].pairingGuidance && (
-                              <p className="text-[11px] text-amber-300/60 pl-5">{batchPreferenceRoles[index].pairingGuidance}</p>
-                            )}
-                            {batchPreferenceRoles[index].pairingSuggestions.length > 0 && (
-                              <div className="pl-5 space-y-1">
-                                <p className="text-[10px] text-amber-400/50 font-medium">Try pairing with:</p>
-                                {batchPreferenceRoles[index].pairingSuggestions.map((s, si) => (
-                                  <p key={si} className="text-[11px] text-amber-300/80 font-mono truncate" data-testid={`suggestion-pair-${index}-${si}`}>
-                                    {s.filename} <span className="text-amber-400/50 font-sans">— {s.reason}</span>
-                                  </p>
-                                ))}
-                              </div>
-                            )}
-                          </div>
-                        )}
 
                         <p className="text-sm text-foreground/80">{r.advice}</p>
 
--- /mnt/data/cab17_orig/Cab-Analyzer-main/client/src/components/ResultCard.tsx	2026-02-18 04:47:43.000000000 +0000
+++ /mnt/data/cab17/Cab-Analyzer-main/client/src/components/ResultCard.tsx	2026-02-18 05:00:19.313984565 +0000
@@ -132,12 +132,9 @@
   const { results, best } = learnedProfile && activeProfiles
     ? scoreWithAvoidPenalty(featuresFromBands(bands), activeProfiles, learnedProfile)
     : activeProfiles
     ? scoreAgainstAllProfiles(featuresFromBands(bands), activeProfiles)
     : scoreAgainstAllProfiles(featuresFromBands(bands));
 
-  let role: string | null = null;
   let unlikelyToUse = false;
   let unlikelyReason: string | null = null;
   const avoidHits: string[] = [];
   let pairingGuidance: string | null = null;
 
   if (learnedProfile && learnedProfile.status !== "no_data" && activeProfiles) {
-    const { results: indResults } = scoreIndividualIR(featuresFromBands(bands), activeProfiles, learnedProfile);
-    const featured = indResults.find((m) => m.profile === "Featured");
-    const body = indResults.find((m) => m.profile === "Body");
-    const fScore = featured?.score ?? 0;
-    const bScore = body?.score ?? 0;
-
-    const shotIntent = filename ? inferShotIntentFromFilename(filename) : null;
-    const intentBonus = shotIntent && shotIntent.confidence > 0 ? Math.round(8 * shotIntent.confidence) : 0;
-    const adjustedF = shotIntent?.role === "featured" ? fScore + intentBonus : fScore;
-    const adjustedB = shotIntent?.role === "body" ? bScore + intentBonus : bScore;
-    const bestScore = Math.max(adjustedF, adjustedB);
-
-    if (bestScore >= 35) {
-      role = adjustedF >= adjustedB ? "" : "";
-    }
+    // Legacy preference-role scoring ("Featured"/"Body" element) is deprecated in favor of musical roles.
+    // We still keep avoid-zone guidance + unlikely-to-use warnings based on overall best profile score.
+    const bestScore = (best?.score ?? 0);
 
     const ratio = bands.mid > 0 ? bands.highMid / bands.mid : 0;
     const lowMidPlusMid = bands.lowMid + bands.mid;
     const avoidTypes: string[] = [];
@@ -217,26 +214,10 @@
     }
   }
 
   return (
     <div className="mt-3 p-3 rounded-lg bg-white/[0.03] border border-white/5">
-      <div className="flex items-center gap-2 mb-2">
-        <Target className="w-4 h-4 text-indigo-400" />
-        <span className="text-xs font-semibold text-indigo-400">Preference Match</span>
-      </div>
-      <div className="flex items-center gap-2 mb-2 flex-wrap">
-        {results.map((r) => (
-          <ProfileMatchBadge key={r.profile} match={r} />
-        ))}
-        {role && (
-          <span className={cn(
-            "inline-flex items-center gap-1 text-xs font-mono px-2 py-1 rounded border",
-            role === ""
-              ? "bg-cyan-500/15 text-cyan-400 border-cyan-500/25"
-              : "bg-amber-500/15 text-amber-400 border-amber-500/25"
-          )} data-testid={`badge-role-${role === "" ? "feature" : "body"}`}>
-            <Layers className="w-3 h-3" />
-            {role}
-          </span>
-        )}
-      </div>
+      <div className="flex items-center gap-2 mb-2">
+        <AlertTriangle className="w-4 h-4 text-amber-400" />
+        <span className="text-xs font-semibold text-amber-400">Blend Guidance</span>
+      </div>
       {unlikelyToUse && unlikelyReason && (
         <div className="flex items-start gap-2 p-2 mb-2 rounded bg-amber-500/10 border border-amber-500/20" data-testid="warning-unlikely-to-use">
           <ShieldAlert className="w-3.5 h-3.5 text-amber-400 mt-0.5 flex-shrink-0" />
           <div>
             <p className="text-xs font-medium text-amber-400">Low match</p>
@@ -352,30 +333,6 @@
       {filename && (
         <div className="flex items-center gap-2 text-sm font-mono text-muted-foreground border-b border-white/10 pb-4 flex-wrap">
           <Activity className="w-4 h-4 text-primary" />
           <span className="text-foreground font-medium">{filename}</span>
-          {(() => {
-            const intent = inferShotIntentFromFilename(filename);
-            if (intent.role === "neutral" || intent.confidence < 0.3) return null;
-            const isFeature = intent.role === "featured";
-            return (
-              <span
-                className={cn(
-                  "inline-flex items-center gap-0.5 text-[10px] font-mono px-1.5 py-0.5 rounded border",
-                  isFeature
-                    ? "bg-orange-500/10 text-orange-400/80 border-orange-500/20"
-                    : "bg-sky-500/10 text-sky-400/80 border-sky-500/20"
-                )}
-                title={intent.reason}
-                data-testid="badge-shot-intent"
-              >
-                {isFeature ? <Target className="w-2.5 h-2.5" /> : <Layers className="w-2.5 h-2.5" />}
-                {isFeature ? "Feature intent" : "Body intent"}
-              </span>
-            );
-          })()}
         </div>
       )}
 
--- /mnt/data/cab17_orig/Cab-Analyzer-main/client/src/components/ShotIntentBadge.tsx	2026-02-18 04:47:43.000000000 +0000
+++ /mnt/data/cab17/Cab-Analyzer-main/client/src/components/ShotIntentBadge.tsx	2026-02-18 05:00:19.333984453 +0000
@@ -1,53 +1,18 @@
 import { cn } from "@/lib/utils";
 import { Target, Layers } from "lucide-react";
 import { inferShotIntentFromFilename, inferShotIntent } from "@/lib/preference-profiles";
 
 export function ShotIntentBadge({ filename }: { filename: string }) {
-  const intent = inferShotIntentFromFilename(filename);
-  if (intent.role === "neutral" || intent.confidence < 0.3) return null;
-  const isFeature = intent.role === "featured";
-  return (
-    <span
-      className={cn(
-        "inline-flex items-center gap-0.5 text-[9px] font-mono px-1 py-0.5 rounded border",
-        isFeature
-          ? "bg-orange-500/10 text-orange-400/80 border-orange-500/20"
-          : "bg-sky-500/10 text-sky-400/80 border-sky-500/20"
-      )}
-      title={intent.reason}
-      data-testid="badge-shot-intent"
-    >
-      {isFeature ? <Target className="w-2 h-2" /> : <Layers className="w-2 h-2" />}
-      {isFeature ? "Feat" : "Body"}
-    </span>
-  );
+  return null; // legacy feature/body intent badges disabled
 }
 
 export function ShotIntentBadgeFromGear({ mic, position }: { mic?: string; position?: string }) {
-  if (!mic && !position) return null;
-  const intent = inferShotIntent(mic, position);
-  if (intent.role === "neutral" || intent.confidence < 0.3) return null;
-  const isFeature = intent.role === "featured";
-  return (
-    <span
-      className={cn(
-        "inline-flex items-center gap-0.5 text-[9px] font-mono px-1 py-0.5 rounded border",
-        isFeature
-          ? "bg-orange-500/10 text-orange-400/80 border-orange-500/20"
-          : "bg-sky-500/10 text-sky-400/80 border-sky-500/20"
-      )}
-      title={intent.reason}
-      data-testid="badge-shot-intent"
-    >
-      {isFeature ? <Target className="w-2 h-2" /> : <Layers className="w-2 h-2" />}
-      {isFeature ? "Feat" : "Body"}
-    </span>
-  );
+  return null; // legacy feature/body intent badges disabled
 }