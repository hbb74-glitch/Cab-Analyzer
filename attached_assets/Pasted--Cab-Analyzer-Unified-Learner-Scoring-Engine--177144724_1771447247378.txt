// ============================================
// Cab Analyzer – Unified Learner Scoring Engine
// v23 Upgrade – Single File Patch
// ============================================

/*
This patch:
1. Adds global preference weight model
2. Adds vote-based learning
3. Replaces static scoring with adaptive scoring
4. Keeps compatibility with existing IR objects
*/

// ==========================
// Preference Weight Model
// ==========================

type PreferenceWeights = {
  centroid: number
  tilt: number
  smooth: number
  hiMid: number
  lowMid: number
  presence: number
  fizzPenalty: number
}

let weights: PreferenceWeights = {
  centroid: 0,
  tilt: 0,
  smooth: 0,
  hiMid: 0,
  lowMid: 0,
  presence: 0,
  fizzPenalty: 0
}

const LEARNING_RATE = 0.00001
// Small rate because centroid values are large (~2000–3500)

export function getPreferenceWeights(): PreferenceWeights {
  return weights
}

export function updateWeightsFromVote(preferred: any, rejected: any) {
  weights.centroid += LEARNING_RATE * (preferred.centroid_computed_hz - rejected.centroid_computed_hz)
  weights.tilt += LEARNING_RATE * (preferred.spectral_tilt_db_per_oct - rejected.spectral_tilt_db_per_oct)
  weights.smooth += LEARNING_RATE * (preferred.smooth_score - rejected.smooth_score)
  weights.hiMid += LEARNING_RATE * (preferred.hiMidMid_ratio - rejected.hiMidMid_ratio)
  weights.lowMid += LEARNING_RATE * (preferred.lowMid_pct - rejected.lowMid_pct)
  weights.presence += LEARNING_RATE * (preferred.presence_pct - rejected.presence_pct)
  weights.fizzPenalty += LEARNING_RATE * (rejected.air_pct - preferred.air_pct)
}

// ==========================
// Adaptive Learned Score
// ==========================

export function scoreIR(ir: any): number {
  const w = weights

  const learnedComponent =
    w.centroid * ir.centroid_computed_hz +
    w.tilt * ir.spectral_tilt_db_per_oct +
    w.smooth * ir.smooth_score +
    w.hiMid * ir.hiMidMid_ratio +
    w.lowMid * ir.lowMid_pct +
    w.presence * ir.presence_pct -
    w.fizzPenalty * ir.air_pct

  // Keep original static score influence for stability
  const baseScore = ir.score || 0

  return baseScore + learnedComponent
}