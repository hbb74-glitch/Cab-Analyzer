cd Cab-Analyzer-main
git apply - <<'PATCH'
diff --git a/client/src/pages/Analyzer.tsx b/client/src/pages/Analyzer.tsx
index c3a6a22..f5d4b91 100644
--- a/client/src/pages/Analyzer.tsx
+++ b/client/src/pages/Analyzer.tsx
@@ -1960,8 +1960,12 @@ export default function Analyzer() {
   } = useResults();
   const batchMetricsByFilenameRef = useRef<Map<string, AudioMetrics>>(new Map());
   // Must be declared before any callbacks/memos that read it (TDZ safety)
   const speakerStatsRef = useRef<Map<string, SpeakerStats>>(new Map());
+  // IMPORTANT: refs do not trigger rerenders. We also keep a state copy so
+  // "Foundation Candidate" recalculates once speaker stats are computed.
+  const [speakerStatsMap, setSpeakerStatsMap] = useState<Map<string, SpeakerStats>>(new Map());
 
   const { data: learnedProfile } = useQuery<LearnedProfileData>({
     queryKey: ["/api/preferences/learned"],
   });
@@ -95032,7 +95036,7 @@ export default function Analyzer() {
   const foundationCandidateBySpeaker = useMemo(() => {
     const map = new Map<string, string>();
     if (!batchResult?.results?.length) return map;
+    if (!speakerStatsMap || speakerStatsMap.size === 0) return map;
 
     type Cand = { fn: string; score: number };
     const bestBySpeaker = new Map<string, Cand>();
@@ -95040,9 +95044,9 @@ export default function Analyzer() {
       const fn = String(r?.filename ?? r?.name ?? "");
       if (!fn) continue;
       const spk = inferSpeakerIdFromFilename(fn);
-      const st: any = speakerStatsRef.current.get(spk);
+      const st: any = speakerStatsMap.get(spk);
       if (!st) continue;
 
       const centroid = Number(r?.centroid_computed_hz ?? r?.spectralCentroidHz ?? r?.spectralCentroid ?? 0);
       const tilt = Number(r?.spectral_tilt_db_per_oct ?? r?.tiltDbPerOct ?? r?.spectralTilt ?? 0);
       const ext = Number(r?.rolloff_or_high_extension_hz ?? r?.rolloffFreq ?? r?.rolloffFrequency ?? r?.highExtensionHz ?? 0);
@@ -101575,7 +101579,13 @@ export default function Analyzer() {
         }
       }
-      speakerStatsRef.current = computeSpeakerStats(rows);
+      const computed = computeSpeakerStats(rows);
+      speakerStatsRef.current = computed;
+      // Trigger rerender so Foundation Candidate memo recalculates
+      // (useMemo doesn't react to ref.current changes)
+      setSpeakerStatsMap(computed);
     } catch {}
   }, [batchIRs]);
PATCH